# JSON Mode 自动提示功能说明

## ✨ 功能介绍

现在，当你勾选或取消勾选"启用 JSON Mode"时，系统会自动在System Prompt中添加或删除JSON格式提示，无需手动编辑！

---

## 🎯 工作原理

### 勾选 JSON Mode 时

```
原始 Prompt:
"你是一个游戏DM，负责控制NPC的对话..."

↓ 自动添加 ↓

更新后的 Prompt:
"你是一个游戏DM，负责控制NPC的对话...

重要：请使用JSON格式返回结果。"
```

### 取消勾选 JSON Mode 时

```
带提示的 Prompt:
"你是一个游戏DM，负责控制NPC的对话...

重要：请使用JSON格式返回结果。"

↓ 自动删除 ↓

恢复后的 Prompt:
"你是一个游戏DM，负责控制NPC的对话..."
```

---

## 📝 使用方法

### 第一步：编写System Prompt

在配置页面编写你的System Prompt，正常编写即可，**不需要手动添加JSON相关说明**：

```
你是一个资深的游戏DM，负责控制NPC的对话和行为。
根据故事背景、NPC列表和目标，以及玩家的输入，指挥NPC进行对话。

重要原则：
- 记住之前的对话内容
- 保持对话的连贯性
- 根据语境判断应该让几个NPC回应
```

### 第二步：勾选 JSON Mode

勾选"☑ 启用 JSON Mode"复选框

**系统会自动添加**：

```
你是一个资深的游戏DM，负责控制NPC的对话和行为。
根据故事背景、NPC列表和目标，以及玩家的输入，指挥NPC进行对话。

重要原则：
- 记住之前的对话内容
- 保持对话的连贯性
- 根据语境判断应该让几个NPC回应

重要：请使用JSON格式返回结果。
```

✅ **提示自动添加到末尾**

### 第三步：取消勾选（如果需要）

取消勾选"☐ 启用 JSON Mode"

**系统会自动删除JSON提示**，恢复到原始内容。

---

## 🎨 视觉提示

每个模块的 JSON Mode 复选框旁边都有提示文字：

```
☐ 启用 JSON Mode  （勾选后自动添加JSON提示）
```

---

## 💡 适用模块

此功能适用于以下模块：

1. ✅ **Module 1: 对话模块**
2. ✅ **Module 2: 总结模块**
3. ✅ **Module 3: 故事模块**

**注意**：Memory Module (记忆模块) 始终使用JSON模式，无需此功能。

---

## 🔍 技术细节

### 添加的提示文本

```javascript
'\n\n重要：请使用JSON格式返回结果。'
```

- 前面有两个换行符，与原prompt分隔
- 简洁明确地要求使用JSON格式

### 智能检测

- ✅ 不会重复添加提示（检测是否已存在）
- ✅ 精确删除提示（只删除自动添加的部分）
- ✅ 实时生效（修改后立即在textarea中可见）

### 控制台日志

勾选/取消勾选时，浏览器控制台会显示：

```
✅ 已添加 JSON Mode 提示到 module1-prompt
```

或

```
❌ 已删除 JSON Mode 提示从 module1-prompt
```

---

## 📋 使用示例

### 示例 1：对话模块

**步骤**：

1. 编写对话模块的System Prompt（不含JSON说明）
2. 勾选"启用 JSON Mode"
3. ✅ 系统自动添加JSON提示
4. 点击"开始"使用

**效果**：AI会按照JSON格式返回结果

### 示例 2：切换格式

**场景**：想测试文本格式和JSON格式的区别

1. 初始状态：☑ 启用 JSON Mode
2. 点击开始，使用JSON格式
3. 返回配置页面
4. 取消勾选：☐ 启用 JSON Mode
5. ✅ 系统自动删除JSON提示
6. 再次开始，使用文本格式

### 示例 3：自定义JSON提示

如果你想使用更详细的JSON说明：

**选项A**：手动编写
```
你的prompt内容...

请返回JSON格式，结构如下：
{
  "responses": [...],
  "metadata": {...}
}
```

**不要勾选"启用 JSON Mode"**，因为会添加额外的提示。

**选项B**：使用自动提示
- 勾选"启用 JSON Mode"
- 让系统添加基本的JSON提示
- 然后手动补充详细的JSON结构说明

---

## ⚠️ 注意事项

### 1. 手动编辑了Prompt

如果你手动在Prompt中写了"请使用JSON格式返回"：

- ✅ 勾选JSON Mode时，系统会检测到已存在，**不会重复添加**
- ✅ 取消勾选时，只会删除自动添加的部分

### 2. 保存配置

- JSON Mode的提示会直接修改textarea的内容
- 点击"开始"后，修改后的prompt会被保存到state中
- 你可以实时看到prompt的变化

### 3. Memory Module

Memory Module（记忆模块）**始终使用JSON模式**，没有JSON Mode复选框，因为：
- 记忆更新必须是结构化的JSON
- 不支持文本格式

---

## 🎯 最佳实践

### 推荐做法

1. **专注于核心逻辑**
   - 在System Prompt中专注编写AI的角色和任务
   - 不用担心JSON格式说明

2. **需要JSON时勾选**
   - 想要结构化输出时勾选JSON Mode
   - 系统会自动处理格式说明

3. **灵活切换**
   - 可以随时勾选/取消
   - 方便测试不同格式的效果

### 不推荐做法

1. ❌ 手动写JSON提示 + 勾选JSON Mode
   - 可能导致重复的提示

2. ❌ 勾选JSON Mode但prompt中说明要返回文本
   - 会产生矛盾的指令

---

## 🐛 故障排除

### Q1: 勾选后没有看到变化？

**A**: 检查以下几点：
1. 查看浏览器控制台（F12）是否有日志
2. Prompt中是否已经包含"请使用JSON格式返回"
3. 刷新页面重试

### Q2: 取消勾选后还有JSON提示？

**A**: 可能原因：
1. 那个提示是你手动写的，不是自动添加的
2. 手动删除那部分即可

### Q3: 提示添加到了中间？

**A**: 
- 系统设计是添加到**末尾**
- 如果出现此情况，可能是代码bug，请反馈

---

## 🚀 功能优势

### Before（之前）

```
❌ 需要手动在每个模块的prompt中写：
   "请使用JSON格式返回结果"
   
❌ 切换格式时需要手动删除/添加

❌ 容易遗忘或写错格式说明
```

### After（现在）

```
✅ 只需勾选/取消勾选复选框

✅ 自动添加/删除，不会出错

✅ 实时可见，即时生效
```

---

## 📊 示例对比

### 对话模块示例

**你的原始Prompt**：
```
你是一个资深的游戏DM（Dungeon Master），负责控制NPC的对话和行为。
根据故事背景、NPC列表和目标，以及玩家的输入，指挥NPC进行对话。
```

**勾选 JSON Mode 后**：
```
你是一个资深的游戏DM（Dungeon Master），负责控制NPC的对话和行为。
根据故事背景、NPC列表和目标，以及玩家的输入，指挥NPC进行对话。

重要：请使用JSON格式返回结果。
```

**AI输出**：
```json
{
  "responses": [
    {
      "npc_name": "老板汤姆",
      "content": "欢迎光临！",
      "emotion": "高兴"
    }
  ]
}
```

---

## 🎉 总结

这个自动提示功能让JSON Mode的使用更加：

- ✅ **便捷**：一键勾选即可
- ✅ **直观**：实时看到prompt变化
- ✅ **智能**：不会重复添加或误删
- ✅ **灵活**：随时切换格式

**享受更流畅的配置体验！** 🎮✨


# 系统架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    AI RPG 测试系统                        │
│                  (单页Web应用 - SPA)                      │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
    ┌───────┐          ┌───────┐          ┌───────┐
    │ HTML  │          │  CSS  │          │  JS   │
    │UI结构 │          │ 样式  │          │ 逻辑  │
    └───────┘          └───────┘          └───────┘
```

## 页面流程图

```
    开始
      │
      ▼
┌──────────┐
│  配置页  │ ◄─────────────────────────┐
│          │                           │
│ • API Key│                           │
│ • 模型   │                        返回配置
│ • 提示词 │                           │
└────┬─────┘                           │
     │ 开始                            │
     ▼                                 │
┌──────────┐                           │
│场景初始化│                           │
│          │                           │
│ • 故事   │                           │
│ • NPC    │                           │
│ • 目标   │                           │
└────┬─────┘                           │
     │ 开始对话                        │
     ▼                                 │
┌──────────┐                           │
│  对话页  │                           │
│          │                           │
│ • 显示   │                           │
│ • 输入   │◄──────┐                  │
│ • 发送   │       │                  │
└────┬─────┘       │                  │
     │ 结束对话    │ 下一幕            │
     ▼             │                  │
┌──────────┐       │                  │
│ 总结页   │───────┘                  │
│          │                           │
│ • 总结   │                           │
│ • 下一幕 │───────────────────────────┘
└──────────┘
```

## 数据流程

### 1. 配置阶段
```
用户输入
   │
   ├─► API Key ──────┐
   ├─► 模型选择 ─────┤
   └─► System Prompt ┤
                     │
                     ▼
                state对象
                (全局状态)
```

### 2. 场景初始化
```
用户输入
   │
   ├─► 故事总结 ───┐
   ├─► NPC列表 ────┤
   └─► NPC目标 ────┤
                   │
                   ▼
              state.scene
              (场景状态)
```

### 3. 对话循环
```
玩家输入
   │
   ▼
构建提示词 ──────┐
   │            │
   │            ▼
   │      ┌──────────┐
   │      │ OpenAI   │
   │      │ API Call │
   │      └──────────┘
   │            │
   │            ▼
   │       AI回应
   │            │
   │            ▼
   │       解析NPC
   │            │
   ▼            ▼
显示对话 ◄───────┘
   │
   ▼
聊天历史
```

### 4. 总结与故事生成
```
结束对话
   │
   ▼
┌─────────────────┐
│   总结模块      │
│                 │
│ Input:          │
│ • 故事背景      │
│ • NPC目标       │
│ • 聊天记录      │
└────────┬────────┘
         │
         ▼
    场景总结
         │
         ▼
┌─────────────────┐
│   故事模块      │
│                 │
│ Input:          │
│ • 场景总结      │
│ • NPC列表       │
│ • NPC目标       │
└────────┬────────┘
         │
         ▼
   下一幕故事
```

## 模块交互

```
┌─────────────────────────────────────────┐
│              前端 (Browser)              │
├─────────────────────────────────────────┤
│                                         │
│  ┌────────┐   ┌────────┐   ┌────────┐ │
│  │ 对话   │   │ 总结   │   │ 故事   │ │
│  │ 模块   │   │ 模块   │   │ 模块   │ │
│  └───┬────┘   └───┬────┘   └───┬────┘ │
│      │            │            │      │
│      └────────────┼────────────┘      │
│                   │                   │
│              ┌────▼────┐              │
│              │ API调用  │              │
│              │ 管理器   │              │
│              └────┬────┘              │
│                   │                   │
└───────────────────┼───────────────────┘
                    │ HTTPS
                    ▼
        ┌──────────────────────┐
        │   OpenAI API         │
        │                      │
        │ • GPT-4o             │
        │ • GPT-4o-mini        │
        │ • GPT-4-turbo        │
        │ • GPT-3.5-turbo      │
        └──────────────────────┘
```

## 状态管理

```javascript
state = {
  // API配置
  apiKey: String,
  model: String,
  
  // 模块配置
  modules: {
    dialogue: {
      prompt: String,
      jsonMode: Boolean
    },
    summary: {
      prompt: String,
      jsonMode: Boolean
    },
    story: {
      prompt: String,
      jsonMode: Boolean
    }
  },
  
  // 场景状态
  scene: {
    storySummary: String,
    npcList: String,
    npcGoals: String,
    chatHistory: Array,
    nextStorySummary: String
  }
}
```

## 核心函数

### 1. API调用层
```
callOpenAI(systemPrompt, userPrompt, useJsonMode)
  ├─► 构建请求
  ├─► 发送到 OpenAI
  ├─► 处理响应
  └─► 错误处理
```

### 2. 页面管理
```
showPage(pageName)
  ├─► 隐藏所有页面
  └─► 显示目标页面

showLoading(show)
  ├─► 显示加载动画
  └─► 禁用用户操作
```

### 3. 消息处理
```
addMessage(type, content, npcName, emotion)
  ├─► 创建消息元素
  ├─► 格式化内容
  ├─► 添加到界面
  └─► 滚动到底部

parseNPCResponse(response, isJson)
  ├─► 检测格式（JSON/文本）
  ├─► 解析内容
  └─► 提取 NPC 信息
```

## 文件结构

```
D:\测试\
│
├─── index.html          # 主HTML文件
│    ├─ 配置页面
│    ├─ 场景初始化页面
│    ├─ 对话页面
│    └─ 总结页面
│
├─── style.css           # 样式文件
│    ├─ 全局样式
│    ├─ 页面布局
│    ├─ 组件样式
│    └─ 动画效果
│
├─── app.js              # JavaScript逻辑
│    ├─ 状态管理
│    ├─ API调用
│    ├─ 事件处理
│    └─ UI更新
│
├─── README.md           # 完整文档
├─── 快速开始.md         # 新手指南
├─── example_scenario.md # 示例场景
├─── 测试说明.txt        # 测试说明
└─── 系统架构.md         # 本文件
```

## 技术栈

### 前端技术
- **HTML5**: 结构语义化
- **CSS3**: 现代样式、动画、响应式设计
- **JavaScript (ES6+)**: 
  - Async/Await 异步处理
  - Fetch API 网络请求
  - DOM 操作
  - 事件处理

### API集成
- **OpenAI Chat Completions API**
  - 支持多种模型
  - 支持 JSON Mode
  - 流式/非流式响应

### 设计模式
- **单页应用 (SPA)**: 无刷新页面切换
- **状态管理**: 集中式状态对象
- **事件驱动**: 用户交互响应
- **模块化**: 功能分离

## 特性亮点

### 🎨 用户界面
- 现代化设计
- 平滑动画过渡
- 响应式布局
- 直观的交互流程

### 🤖 AI集成
- 三模块协同工作
- 灵活的提示词配置
- JSON/文本双模式支持
- 完整的错误处理

### 💬 对话系统
- 实时对话显示
- NPC情绪表现
- 聊天历史记录
- 自动滚动

### 📖 故事生成
- 自动场景总结
- 智能故事续写
- 场景循环系统
- 状态保持

## 扩展性

系统设计考虑了未来扩展：

1. **可添加更多模块**
   - 战斗模块
   - 物品管理模块
   - 成就系统

2. **可支持更多AI提供商**
   - Anthropic Claude
   - Google Gemini
   - 本地模型

3. **可增强存储功能**
   - LocalStorage 保存进度
   - 导出/导入场景
   - 历史记录查看

4. **可优化用户体验**
   - 语音输入/输出
   - 角色头像显示
   - 背景音乐/音效

## 性能优化

- **按需加载**: 页面切换时才渲染
- **事件委托**: 减少事件监听器数量
- **防抖节流**: 避免频繁API调用
- **错误恢复**: 优雅的错误处理

## 安全考虑

- **API Key 保护**: 
  - 前端存储（注意：不适合生产环境）
  - 建议后端代理（生产环境）
  
- **输入验证**: 
  - 必填字段检查
  - 长度限制

- **错误处理**: 
  - API失败提示
  - 网络异常处理

---

这个架构设计确保了系统的：
- ✅ 易用性
- ✅ 可维护性
- ✅ 可扩展性
- ✅ 稳定性


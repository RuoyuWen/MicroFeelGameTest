# 信件生成功能说明 ✉️

## 功能介绍

**信件生成功能**是在每轮对话结束后，由AI以NPC的口吻给玩家写一封信，描述对话后发生的事情、NPC的想法和感受。这封信让玩家更深入地了解NPC的内心世界，增强角色扮演的沉浸感。

---

## ✨ 核心特点

### 1. NPC视角
- 以第一人称（"我"）撰写
- 保持NPC的性格和说话风格
- 展现NPC的内心想法和感受

### 2. 生动的叙事
- 使用文学化的语言
- 富有情感和个性
- 像真实的私人信件

### 3. 承接剧情
- 描述对话后发生的事
- 可以包含对未来的展望
- 给玩家建议或提示

### 4. 可配置
- Module 5独立配置
- 可自定义System Prompt
- 支持启用/禁用
- 支持JSON/文本格式

---

## 🎯 工作流程

### 触发时机

```
玩家点击"结束对话"
    ↓
生成场景总结（Module 2）
    ↓
生成下一幕故事（Module 3）
    ↓
生成NPC信件（Module 5）← 新增
    ↓
显示在总结页面
```

### 输入内容

信件模块接收以下输入：
- **故事总结**：当前场景的故事发展
- **对话记录**：完整的对话历史
- **NPC列表**：所有参与的NPC

### 输出格式

#### JSON格式（推荐）
```json
{
  "npc_name": "战士杰克",
  "letter_content": "亲爱的朋友，\n\n与你并肩作战的经历让我深受鼓舞..."
}
```

#### 文本格式
```
【来信者】战士杰克

【信件内容】
亲爱的朋友，

与你并肩作战的经历让我深受鼓舞...
```

---

## ⚙️ 配置方法

### 1. 在配置页面找到Module 5

```
┌─────────────────────────────────────────┐
│ Module 5: 信件模块 ✉️                   │
├─────────────────────────────────────────┤
│ System Prompt:                          │
│ [文本框]                                │
│                                          │
│ ☑ 启用 JSON Mode                        │
│ ☑ 启用信件生成                          │
└─────────────────────────────────────────┘
```

### 2. 默认System Prompt

系统提供了一个默认配置：

```
你是一个富有文学素养的作家，擅长以NPC的口吻撰写生动的信件。

你的任务是根据对话内容和故事发展，以某个NPC的视角写一封信给玩家。

信件要求：
1. 选择对话中最活跃或与玩家互动最多的NPC作为来信者
2. 使用第一人称（"我"）以NPC的口吻写作
3. 描述对话后NPC的想法、感受或发生的事情
4. 保持NPC的性格特征和说话风格
5. 语言生动、富有情感，像真实的私人信件
6. 字数控制在200-400字
7. 可以包含对未来的展望或给玩家的建议
```

### 3. 自定义Prompt示例

#### 风格A：更加文艺
```
你是一位细腻的诗人，擅长用优美的语言表达情感。
请以NPC的口吻写一封充满诗意的信...
```

#### 风格B：更加实用
```
你是一位务实的顾问。
请以NPC的口吻写一封信，重点关注：
- 对话的实际收获
- 具体的行动建议
- 未来的合作计划
```

#### 风格C：特定角色风格
```
你正在扮演一个中世纪的骑士。
信件应该：
- 使用古典的语言风格
- 包含骑士的荣誉感
- 展现对使命的坚定
```

### 4. 启用/禁用

- **启用信件生成** ☑：每次场景结束时生成信件
- **启用 JSON Mode** ☑：使用JSON格式输出（推荐）

---

## 📖 使用示例

### 示例1：基础对话后的信件

**场景**：酒馆，玩家与老板对话

**对话内容**：
```
玩家："我叫艾伦，是个冒险者。"
老板："欢迎！需要什么？"
玩家："听说森林里有魔物？"
老板："是的，很危险，小心点。"
```

**生成的信件**：
```
✉️ 来自 老板汤姆 的信

亲爱的艾伦，

你离开后，我一直在想你问的那些问题。
森林里的魔物确实不简单，这些天已经有好几个
冒险者出事了。

我知道劝也劝不住你这样的年轻人，但还是想
提醒你：黑暗森林深处有一座废弃的哨塔，
如果遇到危险，可以暂时躲避。

另外，明天早上我会准备一些补给品，
如果你需要，随时来取。

保重，年轻的冒险者。

—— 老板汤姆
```

### 示例2：深度互动后的信件

**场景**：训练场，与战士杰克并肩作战

**对话内容**：
```
玩家："杰克，愿意和我组队吗？"
杰克："当然！我正需要个靠谱的伙伴。"
（经过几轮对话和战斗）
玩家："我们配合得很好。"
杰克："是啊，我很高兴遇到你。"
```

**生成的信件**：
```
✉️ 来自 战士杰克 的信

我的朋友，

今天与你并肩作战的经历，让我想起了
多年前在军中的日子。那种默契的配合，
那种背靠背的信任，已经很久没有体验过了。

说实话，自从退役后，我一直在寻找新的目标。
也许，和你一起冒险就是我一直在等待的机会。
你的勇气和战斗技巧让我印象深刻。

明天我会去城外的铁匠那里维修装备，
如果你也需要，我们可以一起去。顺便，
我还想和你聊聊我们下一步的计划。

森林的挑战还在前方，但有你这样的伙伴，
我充满信心。

让我们一起面对未来的挑战！

—— 你的战友，杰克
```

### 示例3：剧情转折后的信件

**场景**：玩家发现了NPC的秘密

**对话内容**：
```
玩家："我看到了地下室的东西..."
法师露娜："你...不该看到那个。"
玩家："你在研究禁忌魔法？"
露娜："我有我的理由...请相信我。"
```

**生成的信件**：
```
✉️ 来自 法师露娜 的信

艾伦，

我知道你一定对今天看到的事情感到困惑。
是的，我一直在研究那些被禁止的魔法，
但不是你想的那样。

三年前，我的妹妹被黑暗魔法诅咒，
变成了石像。所有的治疗法术都无效，
唯一的希望就是那些被禁止的古老魔法。

我知道这很危险，也知道这违背了法师公会的规则，
但她是我唯一的亲人。我必须尝试。

请不要告诉其他人，至少在我找到解除诅咒的方法之前。
如果你愿意帮我...我会非常感激。

明晚子夜，如果你想知道更多，来塔楼找我。
我会告诉你一切。

—— 露娜
```

---

## 🎨 信件样式

### 显示效果

信件会以特殊的视觉样式展示：

- 📄 **淡黄色背景**：仿古信纸效果
- ✉️ **信封图标**：标识信件
- 🎨 **金色边框**：突出显示
- 📝 **衬线字体**：增加文学感
- 🖋️ **署名**：信件末尾NPC签名

### CSS样式

```css
/* 淡黄色背景，仿古纸张 */
background: linear-gradient(to bottom, #fef6e4, #ffffff);
border: 2px solid #d4af37; /* 金色边框 */

/* 衬线字体，增加文学感 */
font-family: 'Georgia', 'Times New Roman', serif;

/* 文本缩进，像真实信件 */
text-indent: 2em;
```

---

## 🔧 技术实现

### Module 5的位置

```javascript
state.modules = {
    dialogue: { ... },  // Module 1: 对话
    summary: { ... },   // Module 2: 总结
    story: { ... },     // Module 3: 故事
    memory: { ... },    // Module 4: 记忆
    letter: {           // Module 5: 信件 ← 新增
        prompt: '',
        jsonMode: false,
        enabled: true
    }
};
```

### 调用时机

```javascript
// 在场景结束时
document.getElementById('end-dialogue-btn').addEventListener('click', async () => {
    // 1. 生成总结
    await generateSummary();
    
    // 2. 生成下一幕
    await generateNextScene();
    
    // 3. 生成信件 ← 新增
    if (state.modules.letter.enabled) {
        await generateNPCLetter();
    }
});
```

### API调用

```javascript
async function generateNPCLetter(chatHistory, sceneSummary) {
    const letterPrompt = `
    故事总结：${sceneSummary}
    对话记录：${chatHistory}
    NPC列表：${state.scene.npcList}
    
    请选择一个NPC，以TA的口吻写信...
    `;
    
    const response = await callOpenAI(
        state.modules.letter.prompt,  // System Prompt
        letterPrompt,                  // User Prompt
        state.modules.letter.jsonMode  // JSON模式
    );
    
    displayNPCLetter(response);
}
```

---

## 💡 使用建议

### 1. 选择合适的格式

**推荐使用JSON格式**：
- ✅ 结构化，易于解析
- ✅ 更可靠的显示
- ✅ 便于后续处理

**文本格式适合**：
- 想要更自由的格式
- AI可能生成更创意的内容

### 2. 调整Prompt以适应游戏风格

#### 严肃奇幻风格
```
信件应该庄重、正式，使用古典语言...
```

#### 轻松幽默风格
```
信件应该轻松、有趣，可以包含玩笑...
```

#### 现代都市风格
```
信件可以使用现代语言，像是短信或邮件...
```

### 3. 字数控制

- **200-400字**：默认，适中的篇幅
- **100-200字**：简短，快速阅读
- **400-600字**：详细，深度叙事

### 4. 何时禁用信件功能

如果遇到以下情况，可以禁用：
- ❌ 对话过于简短，没有足够内容
- ❌ 想要快速推进剧情
- ❌ 降低AI调用成本

---

## 🎯 信件的作用

### 1. 增强沉浸感
- 玩家能从NPC视角看待故事
- 了解NPC的内心世界
- 建立更深的情感连接

### 2. 推进剧情
- 揭示NPC的秘密
- 提供额外线索
- 暗示未来发展

### 3. 角色塑造
- 展现NPC的性格
- 增加角色深度
- 使NPC更立体

### 4. 玩家指引
- 提供行动建议
- 指出可能的选择
- 给予鼓励或警告

---

## ⚠️ 注意事项

### 1. 性能影响

每次场景结束会额外调用一次API：
- 增加约500-800 tokens
- 成本增加：约$0.0001/次（GPT-4o-mini）
- 响应时间：额外2-5秒

### 2. 与其他模块的关系

- **独立于记忆系统**：不会影响玩家记忆
- **在故事模块之后**：使用总结后的信息
- **可单独禁用**：不影响其他功能

### 3. 信件质量

信件质量取决于：
- System Prompt的质量
- 对话的丰富程度
- AI模型的能力（GPT-4更好）

---

## 🎨 自定义示例

### 示例1：诗意信件

**Prompt**：
```
你是一位浪漫的诗人，用诗意的语言写信。
每封信都应该：
- 包含对自然的描写
- 使用比喻和象征
- 富有哲理和深意
```

**效果**：
```
月光如水，思绪万千。

今夜，我独坐窗前，回想起白天与你的对话。
你的话语如同清泉，洗涤着我尘封的心灵...
```

### 示例2：实用信件

**Prompt**：
```
你是一位务实的顾问，写作简洁明了。
每封信都应该：
- 总结要点
- 列出行动清单
- 给出明确建议
```

**效果**：
```
今日总结：
1. 你了解了森林的危险
2. 我们达成了合作意向
3. 明天需要准备补给

建议：
- 购买治疗药水×5
- 检查装备耐久度
- 早上8点集合
```

---

## 🎉 总结

信件生成功能为AI RPG系统增添了全新的叙事维度：

- ✅ **Module 5**：独立的AI模块
- ✅ **可配置**：System Prompt可编辑
- ✅ **可选功能**：可启用/禁用
- ✅ **美观呈现**：特殊的信件样式
- ✅ **增强体验**：深化角色扮演

通过NPC的来信，玩家可以更深入地了解角色的内心世界，
体验更丰富、更沉浸的游戏体验！

**开始使用吧，期待收到第一封NPC的来信！** ✉️✨


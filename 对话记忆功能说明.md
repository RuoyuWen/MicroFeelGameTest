# 对话记忆功能说明

## ✨ 新功能：对话记忆

### 问题描述

**之前的问题：**
- AI 每次回应时不记得之前说过什么
- 每次对话都是独立的，没有上下文
- NPC 会忘记之前发生的事情
- 对话缺乏连贯性

### 解决方案

**现在的改进：**
- ✅ AI 会记住最近 10 轮对话（20 条消息）
- ✅ NPC 可以引用之前的对话内容
- ✅ 保持对话的连贯性和一致性
- ✅ NPC 会记得玩家说过的话

---

## 🔧 技术实现

### 核心改动

#### 1. 修改 `callOpenAI` 函数

**支持两种调用方式：**

```javascript
// 方式1：简单调用（用于总结、故事模块）
callOpenAI(systemPrompt, userPrompt, useJsonMode)

// 方式2：带历史记录（用于对话模块）
callOpenAI(systemPrompt, messagesArray, useJsonMode)
```

**实现逻辑：**
```javascript
if (typeof userPromptOrMessages === 'string') {
    // 简单调用
    messages = [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt }
    ];
} else if (Array.isArray(userPromptOrMessages)) {
    // 带历史记录
    messages = [
        { role: 'system', content: systemPrompt },
        ...userPromptOrMessages
    ];
}
```

#### 2. 构建包含历史的消息数组

**消息结构：**
```javascript
const messages = [];

// 1. 场景信息（始终包含）
messages.push({
    role: 'user',
    content: `故事背景、NPC列表、目标...`
});

// 2. 历史对话（最近10轮）
for (const msg of recentHistory) {
    if (msg.role === 'player') {
        messages.push({ role: 'user', content: `玩家：${msg.content}` });
    } else if (msg.role === 'npc') {
        messages.push({ role: 'assistant', content: msg.content });
    }
}

// 3. 当前玩家输入
messages.push({ role: 'user', content: `玩家：${userInput}` });
```

#### 3. 历史记录限制

**为什么限制为 10 轮对话？**

- ✅ 避免 token 消耗过多
- ✅ 保持响应速度
- ✅ 10 轮对话通常已经足够提供上下文
- ✅ 更早的对话可以通过"故事总结"来保留

**计算：**
```javascript
const maxHistory = 20; // 10轮对话 = 20条消息（玩家+NPC）
const recentHistory = state.scene.chatHistory.slice(-maxHistory);
```

---

## 📊 对话流程

### 完整流程图

```
玩家输入
    │
    ▼
构建消息数组
    │
    ├─► 场景信息（固定）
    │
    ├─► 历史对话 1
    │   ├─ 玩家：...
    │   └─ NPC：...
    │
    ├─► 历史对话 2
    │   ├─ 玩家：...
    │   └─ NPC：...
    │
    ├─► ... (最多10轮)
    │
    └─► 当前输入
        └─ 玩家：...
    │
    ▼
调用 OpenAI API
    │
    ▼
NPC 响应（记得历史）
    │
    ▼
保存到历史记录
```

### 示例对话

**第1轮：**
```
玩家："老板，给我来杯啤酒。"
NPC老板："好的，马上来！3个铜币。" [情绪：高兴]
```

**第2轮：**
```
玩家："有点贵啊。"
NPC老板："这可是上等麦酒，物有所值！" [情绪：平静]
```
✅ NPC 记得之前说过"3个铜币"

**第3轮：**
```
玩家："好吧，给你钱。听说最近有什么奇怪的事吗？"
NPC老板："既然你买了酒，我就告诉你..." [情绪：平静]
```
✅ NPC 记得玩家同意购买

---

## 🎯 使用效果

### 记忆示例

#### 示例 1：连贯对话

```
玩家："我叫艾伦，是个冒险者。"
战士杰克："欢迎，艾伦！我是杰克。" [情绪：高兴]

玩家："杰克，你愿意和我一起去森林吗？"
战士杰克："当然，艾伦！我正需要个伙伴。" [情绪：振奋]
```

✅ 杰克记住了玩家的名字

#### 示例 2：引用之前的信息

```
玩家："有人知道黑暗森林的情况吗？"
法师露娜："那里很危险，有魔物出没。" [情绪：平静]

玩家："我还是想去看看。"
战士杰克："既然露娜说了有魔物，我们得做好准备。" [情绪：平静]
```

✅ 杰克引用了露娜之前说的话

#### 示例 3：记住承诺

```
玩家："如果你们帮我，事成之后每人100金币。"
战士杰克："成交！" [情绪：振奋]
盗贼艾莉丝："我也加入！" [情绪：高兴]

（几轮对话后）

玩家："我们成功了！"
战士杰克："太好了！别忘了你说的100金币哦。" [情绪：高兴]
```

✅ 杰克记得之前的承诺

---

## ⚙️ 配置更新

### System Prompt 更新

**新增的原则：**
```
- 记住之前的对话内容，保持对话的连贯性和一致性
- NPC会记得之前说过的话和发生的事情
```

这会提醒 AI 要利用历史记录来生成更连贯的回应。

---

## 💡 最佳实践

### 如何充分利用记忆功能

**1. 引用之前的对话**
```
玩家："你刚才说的那个线索，能详细说说吗？"
```
AI 会在历史中找到相关线索并展开。

**2. 测试 NPC 记忆**
```
玩家："你还记得我叫什么名字吗？"
```
AI 会从历史中找到你之前说的名字。

**3. 建立关系**
```
玩家："我们从小一起长大，你应该相信我。"
（在后续对话中）
玩家："还记得我们小时候的事吗？"
```
AI 会记得这个设定。

**4. 任务追踪**
```
玩家："我接受这个任务。"
（几轮对话后）
玩家："我已经完成你交代的任务了。"
```
AI 会记得之前的任务。

### 注意事项

**1. 历史限制**
- 只保留最近 10 轮对话
- 更早的对话会被遗忘
- 重要信息应该在"故事总结"中保留

**2. 场景切换**
- 点击"下一幕"后，历史会被清空
- 但重要信息会通过"故事总结"传递

**3. Token 消耗**
- 带历史记录的对话会消耗更多 token
- 对话轮数越多，消耗越大
- 建议适时结束对话，进入下一幕

---

## 🔍 技术细节

### 消息格式

**发送给 OpenAI 的消息数组：**

```javascript
[
  // System 消息
  {
    role: 'system',
    content: 'DM的System Prompt...'
  },
  
  // 场景信息
  {
    role: 'user',
    content: '故事背景：...\nNPC列表：...\nNPC目标：...'
  },
  
  // 历史对话
  {
    role: 'user',
    content: '玩家：你好'
  },
  {
    role: 'assistant',
    content: '[老板] 欢迎光临！ [情绪：高兴]'
  },
  {
    role: 'user',
    content: '玩家：给我来杯酒'
  },
  {
    role: 'assistant',
    content: '[老板] 好的，3个铜币。 [情绪：高兴]'
  },
  
  // 当前输入
  {
    role: 'user',
    content: '玩家：有点贵啊'
  }
]
```

### 历史记录存储

```javascript
state.scene.chatHistory = [
  { role: 'player', content: '你好' },
  { role: 'npc', content: '[老板] 欢迎光临！ [情绪：高兴]' },
  { role: 'player', content: '给我来杯酒' },
  { role: 'npc', content: '[老板] 好的，3个铜币。 [情绪：高兴]' },
  // ...
];
```

---

## 📈 性能影响

### Token 消耗对比

**之前（无记忆）：**
```
System Prompt: ~200 tokens
场景信息: ~150 tokens
当前输入: ~20 tokens
总计: ~370 tokens/次
```

**现在（有记忆，10轮对话）：**
```
System Prompt: ~200 tokens
场景信息: ~150 tokens
历史对话 (10轮): ~800 tokens
当前输入: ~20 tokens
总计: ~1170 tokens/次
```

**增加：** ~800 tokens (约 3 倍)

### 成本估算

**以 GPT-4o-mini 为例：**
- 输入：$0.15 / 1M tokens
- 无记忆：~$0.000055 / 次
- 有记忆：~$0.000175 / 次

**增加成本：** 约 $0.00012 / 次（可忽略）

---

## 🎉 总结

### 改进效果

**之前：**
- ❌ NPC 每次都是"失忆"状态
- ❌ 对话缺乏连贯性
- ❌ 无法建立长期关系

**现在：**
- ✅ NPC 有记忆，对话更自然
- ✅ 可以引用之前的对话
- ✅ 可以建立角色关系
- ✅ 故事发展更合理

### 适用场景

**最适合：**
- 🎯 深度角色扮演
- 🎯 侦探推理（记得线索）
- 🎯 谈判交易（记得承诺）
- 🎯 关系建立（记得互动）

**不太影响：**
- 简单的问答
- 一次性的信息查询

---

**享受更智能、更有记忆的 AI 对话体验！** 🎮✨


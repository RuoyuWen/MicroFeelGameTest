# 故障排除指南

## 常见问题与解决方案

### 🔴 API 相关问题

#### 问题：API 调用失败，提示 "API Error: ..."

**可能原因：**
1. API Key 不正确或已过期
2. OpenAI 账户余额不足
3. 网络连接问题
4. API 请求限制（rate limit）

**解决方案：**
```
✅ 检查步骤：
1. 确认 API Key 是否正确复制（无多余空格）
2. 访问 https://platform.openai.com/account/billing 检查余额
3. 测试网络：访问 https://api.openai.com/ 
4. 如果有 rate limit 错误，等待几分钟后重试
5. 尝试使用 VPN（如果在某些地区）
```

#### 问题：提示 "unauthorized" 或 401 错误

**原因：** API Key 无效

**解决方案：**
```
1. 重新生成 API Key：
   https://platform.openai.com/api-keys
2. 确保复制完整的 Key（以 sk- 开头）
3. 重新输入到配置页面
```

#### 问题：响应非常慢或超时

**原因：** 
- 模型负载高
- 提示词过长
- 网络延迟

**解决方案：**
```
1. 切换到更快的模型（GPT-4o-mini 或 GPT-3.5-turbo）
2. 简化场景描述和对话历史
3. 检查网络连接速度
4. 避免高峰时段使用
```

---

### 🟡 显示相关问题

#### 问题：NPC 回应格式混乱，没有正确解析

**示例：** 
```
看到一大段文本，没有分离 NPC 名字和情绪
```

**解决方案：**
```
方案1：启用 JSON Mode
1. 返回配置页
2. 勾选"对话模块"的"启用 JSON Mode"
3. 重新开始

方案2：改进 System Prompt
在对话模块的 System Prompt 中更明确地说明格式：

"严格按照以下格式返回，每个NPC一行：
[NPC名字] 说话内容 [情绪：情绪名称]

例如：
[张三] 你好，欢迎来到这里！ [情绪：高兴]
[李四] 我们正在等你。 [情绪：平静]"
```

#### 问题：页面显示异常或样式错乱

**原因：** 浏览器兼容性或缓存问题

**解决方案：**
```
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 硬刷新页面（Ctrl+F5）
3. 尝试其他现代浏览器：
   - Google Chrome
   - Microsoft Edge
   - Firefox
4. 检查是否所有文件都在同一目录
```

#### 问题：聊天记录没有自动滚动到底部

**解决方案：**
```
1. 手动滚动查看新消息
2. 刷新页面重新开始
3. 检查浏览器控制台是否有 JavaScript 错误
```

---

### 🟢 功能相关问题

#### 问题：点击按钮没有反应

**检查步骤：**
```
1. 打开浏览器控制台（F12）
2. 查看 Console 标签是否有错误
3. 确认所有必填字段都已填写
4. 刷新页面重试
```

#### 问题：总结或下一幕生成失败

**可能原因：**
- 对话历史太长
- API 返回格式异常
- 提示词配置问题

**解决方案：**
```
1. 如果对话很长，尝试进行较短的对话
2. 检查 System Prompt 是否合理
3. 查看浏览器控制台的详细错误信息
4. 尝试不启用 JSON Mode
```

#### 问题：下一幕按钮一直禁用

**原因：** 故事生成未完成或失败

**解决方案：**
```
1. 等待所有内容加载完成
2. 检查"场景总结"和"下一幕故事"是否都已显示
3. 如果显示"生成失败"，点击"返回配置"重新开始
4. 检查网络和 API 状态
```

---

### 🔵 使用体验问题

#### 问题：修改了 System Prompt 但没有效果

**现象：**
- 修改了 System Prompt
- AI 回应没有改变
- 好像用的还是默认配置

**原因：**
没有点击"开始"按钮保存配置

**解决方案：**

**第一步：确认配置流程**
1. 在配置页面修改 System Prompt
2. **点击"开始"按钮** ⭐ 必须！
3. 重新开始使用

**第二步：验证配置已保存**
1. 按 F12 打开浏览器控制台
2. 查看是否有"配置已保存"的日志
3. 确认显示的 Prompt 是你修改后的

**第三步：验证 AI 调用**
1. 发送一条消息
2. 在控制台查看"🤖 调用 OpenAI API"
3. 查看"📝 System Prompt"是否是你的配置

**详细说明：** 查看 `System_Prompt配置说明.md`

---

#### 问题：AI 生成的内容质量不好

**示例：**
- NPC 回应不符合设定
- 故事发展不合理
- 重复相同的内容

**优化方案：**

**1. 改进 System Prompt**
```
对话模块优化示例：

"你是一个经验丰富的 TRPG DM，擅长根据角色性格和动机
控制 NPC 行为。

关键原则：
- 根据语境智能判断让几个NPC回应（1个、2个或更多）
- 不是所有NPC都必须每次说话，要符合实际情况
- 每个 NPC 都有独特的说话风格
- 回应要符合 NPC 的目标和动机
- 考虑场景氛围和紧张度
- 避免重复相同的话语
- 适当制造冲突或推动情节

返回格式：[NPC名字] 对话内容 [情绪：情绪名称]
只返回需要说话的NPC，不必全部回应。"
```

**2. 提供更详细的场景信息**
```
故事总结示例（详细版）：

"背景：一个蒸汽朋克世界，魔法与科技并存。
你是一名赏金猎人，来到工业城市'齿轮港'寻找失踪的发明家。

当前状况：
- 城市正举办年度发明展
- 多个势力在暗中角力
- 街头出现神秘的机械生物
- 传言有人在进行危险的实验

你的目标：找到发明家，揭开真相"
```

**3. 更具体的 NPC 设定**
```
NPC 设定示例（详细版）：

"1. 发明家协会主席 - 维克多博士
   性格：严谨、保守、重视规则
   目标：维护协会声誉，阻止危险实验
   背景：曾经的激进派，现在的保守派

2. 黑市商人 - 莉莉
   性格：狡猾、贪婪、消息灵通
   目标：从危机中获利，贩卖情报
   背景：有黑白两道的关系

3. 年轻助手 - 艾伦
   性格：理想主义、冲动、忠诚
   目标：找到失踪的导师
   背景：发明家的学徒"
```

**4. 使用更好的模型**
```
推荐模型选择：
✅ GPT-4o - 最佳创意和一致性
✅ GPT-4-turbo - 次优选择
⚠️ GPT-4o-mini - 可用但质量较低
⚠️ GPT-3.5-turbo - 不推荐用于复杂场景
```

#### 问题：故事发展太快或太慢

**调整方案：**

**在 System Prompt 中添加节奏控制：**

```
故事模块优化：

"续写下一幕时，请注意：

节奏控制：
- 不要跳跃太多时间或场景
- 每一幕聚焦一个主要事件
- 保持与上一幕的连贯性
- 给玩家足够的互动空间

下一幕应该：
1. 自然承接上一幕的结果
2. 引入新的挑战或信息
3. 保持悬念和吸引力
4. 提供多个可能的发展方向"
```

---

### ⚙️ 技术问题调试

#### 如何查看详细错误信息

**步骤：**
```
1. 打开浏览器开发者工具
   - Chrome/Edge: F12 或 Ctrl+Shift+I
   - Firefox: F12
   - Safari: Cmd+Option+I (Mac)

2. 切换到 "Console" 标签

3. 重现问题

4. 查看红色错误信息

5. 常见错误类型：
   - Network Error: 网络问题
   - API Error: API 调用失败
   - JSON Parse Error: JSON 格式错误
   - TypeError: 代码逻辑错误
```

#### 如何检查 API 请求

**步骤：**
```
1. 打开开发者工具的 "Network" 标签

2. 执行会触发 API 调用的操作（如发送消息）

3. 找到 "chat/completions" 请求

4. 检查：
   - Status: 应该是 200
   - Request Headers: 检查 Authorization
   - Request Payload: 检查发送的内容
   - Response: 检查返回的内容

5. 如果 Status 不是 200：
   - 400: 请求格式错误
   - 401: API Key 无效
   - 429: 请求过于频繁
   - 500: OpenAI 服务器错误
```

---

### 💡 使用技巧

#### 获得更好效果的建议

**1. 渐进式测试**
```
第一次：使用简单场景测试基本功能
第二次：尝试复杂的 NPC 互动
第三次：测试完整的场景循环
第四次：优化提示词和设定
```

**2. System Prompt 模板**
```
好的 System Prompt 特征：
✅ 明确的角色定位
✅ 清晰的任务说明
✅ 详细的格式要求
✅ 具体的行为准则
✅ 示例（如果需要）

避免：
❌ 过于简单："你是个 NPC"
❌ 矛盾的指令
❌ 过于复杂的规则
❌ 模糊的期望
```

**3. 场景设计**
```
好的场景特征：
✅ 有明确的冲突或目标
✅ NPC 有不同的动机
✅ 有多种可能的发展
✅ 适当的信息量

避免：
❌ 过于开放（"随便聊聊"）
❌ NPC 目标模糊
❌ 信息过载
❌ 没有戏剧张力
```

**4. 对话策略**
```
提高互动质量：
✅ 提出具体的问题
✅ 根据 NPC 的目标引导对话
✅ 尝试不同的角色扮演方式
✅ 注意观察 NPC 的情绪变化

避免：
❌ 过于简短的输入（"好的"、"嗯"）
❌ 脱离场景的话题
❌ 忽视 NPC 的反应
```

---

### 📞 获取帮助

如果以上方法都无法解决问题：

1. **检查系统要求**
   - 现代浏览器（2020年后版本）
   - 稳定的网络连接
   - 有效的 OpenAI API Key
   - 足够的 API 余额

2. **收集信息**
   - 浏览器类型和版本
   - 错误信息截图
   - 控制台日志
   - 操作步骤

3. **查看文档**
   - README.md - 完整文档
   - 快速开始.md - 使用指南
   - 系统架构.md - 技术细节

4. **重新开始**
   - 有时候最简单的方法就是刷新页面
   - 使用浏览器的隐私/无痕模式
   - 清除缓存后重试

---

## 预防性维护

### 定期检查

- ✅ API Key 是否还有效
- ✅ 账户余额是否充足
- ✅ 浏览器是否需要更新
- ✅ System Prompt 是否还合适

### 备份重要内容

由于系统不保存数据，建议：
- 📝 复制优秀的 System Prompt 到文本文件
- 📝 保存有趣的场景设定
- 📝 记录有效的配置组合

### 优化建议

- 🎯 定期回顾和改进 System Prompt
- 🎯 实验不同的模型和参数
- 🎯 记录什么配置产生了最好的结果
- 🎯 与朋友分享有趣的场景

---

**记住：遇到问题不要慌，按步骤排查，总能找到解决方案！** 🎉


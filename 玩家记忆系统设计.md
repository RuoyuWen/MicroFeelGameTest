# 玩家记忆系统设计文档

## 📋 系统概述

玩家记忆系统是一个**跨session持久化**的智能记忆管理系统，能够：
- 🧠 自动记录玩家信息和行为
- 🤝 追踪玩家与NPC的关系发展
- 📝 提取对话中的关键信息
- 🎯 记录目标、承诺和重要事件
- 💾 持久化存储，关闭浏览器后依然保留
- 🔄 在每次对话中自动更新和使用

---

## 📊 数据结构设计

### 玩家记忆变量 (Player Memory)

```json
{
  "player_info": {
    "name": "玩家名字（如果提到）",
    "description": "玩家的外貌、职业等基本描述",
    "personality": "玩家展现出的性格特征",
    "background": "玩家提到的背景故事"
  },
  "key_facts": [
    {
      "fact": "玩家提到或表现出的关键事实",
      "scene": "在哪一幕提到",
      "timestamp": "记录时间"
    }
  ],
  "relationships": {
    "NPC名字": {
      "relationship": "关系类型（友好/敌对/中立/盟友等）",
      "trust_level": "信任等级（1-10）",
      "key_interactions": [
        "重要的互动记录"
      ]
    }
  },
  "goals_and_promises": [
    {
      "type": "goal（目标）或 promise（承诺）",
      "content": "具体内容",
      "related_npc": "相关的NPC",
      "status": "active（进行中）/completed（已完成）/failed（失败）",
      "scene": "提出的场景"
    }
  ],
  "important_events": [
    {
      "event": "重要事件描述",
      "scene": "发生的场景",
      "impact": "对故事的影响"
    }
  ],
  "inventory_mentions": [
    "玩家提到拥有的物品"
  ],
  "skills_and_abilities": [
    "玩家展现或提到的技能和能力"
  ],
  "secrets_discovered": [
    "玩家发现的秘密或线索"
  ]
}
```

### 示例数据

```json
{
  "player_info": {
    "name": "艾伦",
    "description": "年轻的冒险者，身穿皮甲",
    "personality": "勇敢、正直、有些冲动",
    "background": "来自北方的小村庄，寻找失踪的妹妹"
  },
  "key_facts": [
    {
      "fact": "玩家会使用剑术",
      "scene": "第一幕：酒馆",
      "timestamp": "2025-10-16 14:30"
    },
    {
      "fact": "玩家有一把祖传的宝剑",
      "scene": "第一幕：酒馆",
      "timestamp": "2025-10-16 14:35"
    }
  ],
  "relationships": {
    "老板汤姆": {
      "relationship": "友好",
      "trust_level": 7,
      "key_interactions": [
        "购买了啤酒",
        "询问了黑暗森林的信息",
        "老板提供了线索"
      ]
    },
    "战士杰克": {
      "relationship": "盟友",
      "trust_level": 9,
      "key_interactions": [
        "组队一起冒险",
        "承诺事成后给100金币",
        "并肩作战击败了魔物"
      ]
    }
  },
  "goals_and_promises": [
    {
      "type": "goal",
      "content": "找到失踪的妹妹",
      "related_npc": null,
      "status": "active",
      "scene": "第一幕：酒馆"
    },
    {
      "type": "promise",
      "content": "给杰克100金币作为报酬",
      "related_npc": "战士杰克",
      "status": "completed",
      "scene": "第一幕：酒馆"
    }
  ],
  "important_events": [
    {
      "event": "在森林中击败了黑暗魔物",
      "scene": "第二幕：黑暗森林",
      "impact": "获得了村民的信任"
    }
  ],
  "inventory_mentions": [
    "祖传宝剑",
    "50金币",
    "魔法药水"
  ],
  "skills_and_abilities": [
    "剑术",
    "基础魔法",
    "追踪技能"
  ],
  "secrets_discovered": [
    "黑暗森林深处有一个古老的神殿",
    "老板知道更多关于魔物的秘密"
  ]
}
```

---

## 🤖 Memory Module 设计

### 模块职责

Memory Module 是第四个AI模块，专门负责：
1. **分析对话**：理解玩家和NPC的对话内容
2. **提取信息**：识别关键信息（名字、目标、承诺等）
3. **更新记忆**：智能更新玩家记忆变量
4. **保持一致**：确保记忆的连贯性和一致性

### 调用时机

Memory Module 会在以下时机被调用：
- ✅ **每轮对话后**：分析玩家输入和NPC回应
- ✅ **场景结束时**：整合本场景的所有信息
- ✅ **主动请求时**：用户手动触发更新

### System Prompt 设计

```
你是一个智能记忆管理助手，负责维护玩家的记忆档案。

任务：
1. 分析玩家和NPC的对话
2. 提取关键信息（玩家信息、关系、目标、承诺、事件等）
3. 更新玩家记忆变量
4. 保持信息的连贯性和一致性

提取规则：
- 玩家信息：名字、职业、外貌、性格、背景
- 关系变化：与NPC的互动、信任度变化
- 目标和承诺：玩家设定的目标、做出的承诺
- 重要事件：关键的故事发展
- 物品和技能：玩家提到的装备、能力
- 秘密线索：玩家发现的隐藏信息

输出格式：
返回JSON格式的更新指令，只包含需要更新的字段。

注意事项：
- 不要杜撰信息，只记录明确提到的内容
- 合并而不是覆盖已有信息
- 保持客观，不添加主观解释
- 时间戳使用当前时间
```

### 输入格式

```json
{
  "current_memory": { /* 当前的记忆变量 */ },
  "dialogue": {
    "scene": "第X幕：场景名",
    "recent_conversation": [
      {
        "role": "player",
        "content": "玩家说的话"
      },
      {
        "role": "npc",
        "npc_name": "NPC名字",
        "content": "NPC说的话"
      }
    ]
  }
}
```

### 输出格式

```json
{
  "updates": {
    "player_info": {
      "name": "更新的名字（如果提到）"
    },
    "key_facts": [
      {
        "action": "add",
        "fact": "新的关键事实",
        "scene": "当前场景",
        "timestamp": "2025-10-16 14:30"
      }
    ],
    "relationships": {
      "NPC名字": {
        "action": "update",
        "relationship": "更新的关系",
        "trust_level": 8,
        "key_interactions": [
          {
            "action": "add",
            "interaction": "新的互动"
          }
        ]
      }
    },
    "goals_and_promises": [
      {
        "action": "add",
        "type": "promise",
        "content": "新的承诺",
        "related_npc": "相关NPC",
        "status": "active",
        "scene": "当前场景"
      }
    ]
  }
}
```

---

## 🔄 集成流程

### 1. 系统初始化

```
启动系统
    ↓
从 localStorage 加载玩家记忆
    ↓
如果不存在，创建空白记忆
    ↓
显示在配置页面（可选）
```

### 2. 对话流程集成

```
玩家发送消息
    ↓
调用对话模块（包含玩家记忆摘要）
    ↓
NPC回应
    ↓
显示对话
    ↓
调用 Memory Module
    ↓
更新玩家记忆
    ↓
保存到 localStorage
```

### 3. 玩家记忆在对话中的使用

在调用对话模块时，会附加玩家记忆摘要：

```javascript
const memoryContext = `
【玩家记忆档案】
玩家信息：${playerMemory.player_info.name || '未知'} - ${playerMemory.player_info.description || '无'}
性格：${playerMemory.player_info.personality || '未知'}

与NPC的关系：
${Object.entries(playerMemory.relationships).map(([npc, rel]) => 
  `- ${npc}：${rel.relationship}（信任度${rel.trust_level}/10）`
).join('\n')}

当前目标和承诺：
${playerMemory.goals_and_promises
  .filter(g => g.status === 'active')
  .map(g => `- ${g.type === 'goal' ? '目标' : '承诺'}：${g.content}`)
  .join('\n')}

已发现的线索：
${playerMemory.secrets_discovered.join(', ')}
`;
```

这个记忆摘要会作为上下文提供给对话模块，让NPC能够：
- 记得玩家的名字和背景
- 根据关系深度调整态度
- 引用之前的承诺和目标
- 使用玩家发现的线索

---

## 💾 持久化存储

### localStorage 方案

```javascript
// 保存玩家记忆
function savePlayerMemory(memory) {
    localStorage.setItem('ai_rpg_player_memory', JSON.stringify(memory));
}

// 加载玩家记忆
function loadPlayerMemory() {
    const saved = localStorage.getItem('ai_rpg_player_memory');
    return saved ? JSON.parse(saved) : createEmptyMemory();
}

// 创建空白记忆
function createEmptyMemory() {
    return {
        player_info: { name: '', description: '', personality: '', background: '' },
        key_facts: [],
        relationships: {},
        goals_and_promises: [],
        important_events: [],
        inventory_mentions: [],
        skills_and_abilities: [],
        secrets_discovered: []
    };
}

// 清空记忆（重新开始游戏）
function clearPlayerMemory() {
    localStorage.removeItem('ai_rpg_player_memory');
    return createEmptyMemory();
}
```

---

## 🎨 用户界面设计

### 1. 配置页面新增

在配置页面添加 **Module 4: Memory Module**：
- System Prompt 输入框
- 启用/禁用记忆系统
- 查看当前记忆按钮
- 清空记忆按钮

### 2. 记忆查看界面

新增一个"玩家记忆"按钮，点击后显示模态框：

```
╔════════════════════════════════╗
║      玩家记忆档案              ║
╠════════════════════════════════╣
║ 📋 玩家信息                    ║
║   名字：艾伦                   ║
║   描述：年轻的冒险者...        ║
║                                ║
║ 🤝 NPC关系                     ║
║   • 战士杰克：盟友 (9/10)      ║
║   • 老板汤姆：友好 (7/10)      ║
║                                ║
║ 🎯 目标与承诺                  ║
║   ✓ 给杰克100金币 [已完成]     ║
║   ◆ 找到失踪的妹妹 [进行中]    ║
║                                ║
║ 🔍 已发现线索                  ║
║   • 黑暗森林深处有神殿         ║
║                                ║
║ [编辑] [导出] [清空] [关闭]    ║
╚════════════════════════════════╝
```

### 3. 对话页面集成

在对话页面顶部添加：
- 📋 "查看记忆"按钮
- 💾 记忆自动保存指示器（例如：✓ 已保存）

---

## ⚙️ 配置选项

### Memory Module System Prompt（默认）

```
你是一个智能记忆管理助手，负责维护玩家的记忆档案。

你的任务是分析玩家和NPC的对话，提取关键信息并更新玩家记忆。

提取的信息类型：
1. 玩家信息（名字、职业、外貌、性格、背景）
2. 与NPC的关系变化（互动、信任度）
3. 目标和承诺（玩家的目标、做出的承诺）
4. 重要事件（关键的故事发展）
5. 物品和技能（装备、能力）
6. 秘密线索（发现的隐藏信息）

原则：
- 只记录明确提到的内容，不杜撰
- 合并而不是覆盖已有信息
- 保持客观，不添加主观解释
- 关系的信任度用1-10评分
- 承诺和目标要标记状态（active/completed/failed）

返回JSON格式的更新指令，只包含需要更新的字段。
```

### 配置项

```javascript
{
    enableMemorySystem: true,           // 是否启用记忆系统
    memoryUpdateTiming: 'after_each',   // 更新时机：'after_each'（每轮后）/ 'manual'（手动）
    maxKeyFacts: 50,                    // 最多保存的关键事实数量
    maxEventsPerNPC: 10,                // 每个NPC最多保存的互动记录
    memoryContextLength: 500,           // 记忆摘要的最大token长度
    enableAutoSave: true                // 自动保存到localStorage
}
```

---

## 🔧 实现步骤

### Step 1: 添加数据结构

```javascript
// 在 state 中添加
state.playerMemory = loadPlayerMemory();

// 在 state.modules 中添加
state.modules.memory = {
    prompt: '默认的Memory Module prompt',
    enabled: true
};
```

### Step 2: 实现 Memory Module 调用

```javascript
async function updatePlayerMemory(recentDialogue) {
    if (!state.modules.memory.enabled) return;
    
    const input = {
        current_memory: state.playerMemory,
        dialogue: {
            scene: state.scene.storySummary.substring(0, 50),
            recent_conversation: recentDialogue
        }
    };
    
    const response = await callOpenAI(
        state.modules.memory.prompt,
        JSON.stringify(input, null, 2),
        true  // 使用JSON模式
    );
    
    const updates = JSON.parse(response);
    applyMemoryUpdates(state.playerMemory, updates);
    savePlayerMemory(state.playerMemory);
}
```

### Step 3: 集成到对话流程

在发送按钮的事件处理中，NPC响应后添加：

```javascript
// NPC回应后
await updatePlayerMemory([
    { role: 'player', content: userInput },
    { role: 'npc', content: response }
]);
```

### Step 4: 在对话中使用记忆

在构建对话提示时，添加记忆上下文：

```javascript
const contextMessage = `
故事背景：${state.scene.storySummary}

NPC列表：${state.scene.npcList}

NPC目标：${state.scene.npcGoals}

${generateMemoryContext(state.playerMemory)}

请根据上述信息和对话历史，决定让几个NPC回应...
`;
```

---

## 📈 使用效果

### Before（无记忆系统）

```
第一幕：
玩家："我叫艾伦，是个冒险者。"
NPC："欢迎！"

第二幕（几小时后）：
玩家："还记得我吗？"
NPC："你是？"  ❌ 忘记了玩家
```

### After（有记忆系统）

```
第一幕：
玩家："我叫艾伦，是个冒险者。"
NPC："欢迎，艾伦！"
[记忆系统记录：玩家名字 = 艾伦，职业 = 冒险者]

第二幕（几小时后，甚至几天后）：
玩家："还记得我吗？"
NPC："当然记得，艾伦！上次你说要去寻找你失踪的妹妹。" ✅ 完美记忆
```

### 跨场景记忆

```
第一幕：
玩家："如果你们帮我，我给每人100金币。"
[记忆：承诺给100金币，状态=active]

第五幕：
玩家："我们成功了！"
NPC："别忘了你承诺的100金币哦。" ✅ NPC记得承诺
```

---

## 🚀 高级功能（可选扩展）

### 1. 记忆导出/导入

允许玩家导出记忆为JSON文件，在其他设备上导入。

### 2. 记忆分析

提供记忆统计：
- 结识了多少NPC
- 完成了多少目标
- 建立了多少友谊

### 3. 记忆搜索

搜索记忆中的关键词，快速查找信息。

### 4. 记忆时间线

按时间顺序展示玩家的冒险历程。

### 5. AI记忆总结

定期让AI总结玩家的冒险故事。

---

## ⚠️ 注意事项

### Token 消耗

- 每次调用 Memory Module：~500-1000 tokens
- 每次对话附加记忆上下文：~200-500 tokens
- 建议使用 GPT-4o-mini 降低成本

### 隐私

- 所有数据存储在用户本地（localStorage）
- 不会上传到服务器
- 用户可以随时清空记忆

### 性能

- localStorage 有大小限制（通常5MB）
- 记忆过大时需要清理旧数据
- 可以实现自动归档功能

---

## 🎉 总结

玩家记忆系统让AI RPG游戏具有：
- ✅ 真正的角色扮演体验
- ✅ 跨session的连续性
- ✅ NPC能记住玩家
- ✅ 故事发展更合理
- ✅ 玩家的选择有长期影响

**这将把你的AI RPG提升到全新的高度！** 🎮✨


# NPC 初始对话功能说明

## ✨ 新功能

### 功能概述

系统现在支持智能的 NPC 初始问候和对话：

1. **第一幕**：NPC 主动问候玩家，问候内容与故事背景相关
2. **第二幕及以后**：显示故事模块生成的 NPC 初始对话

---

## 🎯 工作流程

### 第一幕（新场景开始）

```
玩家填写场景信息
    ↓
点击"开始对话"
    ↓
AI 自动生成初始问候
    ↓
NPC 主动问候玩家
    ↓
玩家开始对话
```

**示例：**
```
场景：酒馆冒险
故事背景：你刚刚来到"金色狮子"酒馆...

NPC 初始问候：
[老板娘玛丽] 欢迎光临！第一次来我们这里吗？ [情绪：高兴]
```

### 第二幕及以后

```
上一幕结束 → 点击"结束对话"
    ↓
总结模块生成总结
    ↓
故事模块生成下一幕
    ↓
包含：场景描述 + NPC初始对话
    ↓
点击"下一幕"
    ↓
进入新场景
    ↓
自动显示 NPC 初始对话
    ↓
玩家继续对话
```

**示例：**
```
故事模块生成：
场景描述：夜幕降临，你们来到了黑暗森林的入口...

NPC初始对话：
[战士杰克] 准备好了吗？前面可能很危险。 [情绪：平静]

（这个对话会自动显示在新场景的开始）
```

---

## 🔧 技术实现

### 1. 初始问候生成

**触发时机：** 第一次进入对话页面

**调用函数：** `generateInitialGreeting()`

**AI 提示词：**
```
故事背景：[用户输入的故事]
NPC列表：[用户输入的NPC]
NPC目标：[用户输入的目标]

请选择一个最合适的NPC来主动问候玩家，
问候内容要与故事背景相关。

返回格式：[NPC名字] 问候内容 [情绪：情绪动画]
```

**返回示例：**
```
[老板娘玛丽] 欢迎来到金色狮子！需要点什么吗？ [情绪：高兴]
```

### 2. 故事模块生成格式

**更新后的格式：**

**JSON Mode：**
```json
{
  "scene_description": "下一幕的场景描述",
  "npc_dialogue": {
    "npc_name": "NPC名字",
    "content": "对话内容",
    "emotion": "情绪动画"
  }
}
```

**文本模式：**
```
【场景描述】
下一幕的场景描述...

【NPC初始对话】
[NPC名字] 对话内容 [情绪：情绪动画]
```

### 3. 数据流转

**状态保存：**
```javascript
state.scene.nextNPCDialogue = {
  npc_name: "战士杰克",
  content: "准备好了吗？",
  emotion: "平静"
}
```

**下一幕使用：**
```javascript
// 点击"开始对话"时
if (state.scene.nextNPCDialogue) {
  displayStoredNPCDialogue();  // 显示存储的对话
} else {
  generateInitialGreeting();    // 生成新的问候
}
```

---

## 📊 对比

### 之前的行为

| 场景 | 行为 |
|------|------|
| 第一幕 | 进入对话页面，等待玩家输入 |
| 第二幕 | 显示故事描述，需要玩家先说话 |

### 现在的行为

| 场景 | 行为 |
|------|------|
| 第一幕 | NPC 主动问候玩家 ✨ |
| 第二幕 | 显示故事 + NPC 自动开场 ✨ |

---

## 🎨 格式统一

### 所有 NPC 对话的格式

**统一格式要求：**
- NPC 名字
- 说话内容
- 情绪动画（8种：高兴、难过、失望、振奋、绝望、疯狂、希望、平静）

**应用场景：**
1. ✅ 初始问候（对话模块生成）
2. ✅ 对话回应（对话模块生成）
3. ✅ NPC 初始对话（故事模块生成）

**统一的好处：**
- 格式一致，便于解析
- 用户体验更连贯
- 代码更易维护

---

## 💡 使用示例

### 示例 1：奇幻酒馆

**第一幕设置：**
```
故事背景：你来到繁华的"金色狮子"酒馆，这里是冒险者的聚集地
NPC列表：老板娘玛丽、战士杰克、法师露娜
NPC目标：老板娘想招待客人，杰克想找队友，露娜在寻找魔法书
```

**初始问候（AI自动生成）：**
```
[老板娘玛丽] 欢迎光临！第一次来这里吗？要来点什么？ [情绪：高兴]
```

**对话进行...**

**第一幕结束后，故事模块生成：**
```
场景描述：夜幕降临，你们踏上了前往黑暗森林的道路...

NPC初始对话：
[战士杰克] 看那边，森林入口到了。大家小心。 [情绪：平静]
```

**第二幕开始（自动显示）：**
```
[战士杰克] 看那边，森林入口到了。大家小心。 [情绪：平静]
```

### 示例 2：科幻空间站

**第一幕：**
```
[站长陈博士] 欢迎来到新地平线空间站。你的停靠许可已通过。 [情绪：平静]
```

**第二幕（故事生成）：**
```
场景：警报突然响起，空间站的灯光开始闪烁...

[安全主管约翰] 不好了！生命支持系统出现异常！ [情绪：紧张]
```

---

## 🔄 完整场景循环

```
【第一幕】
配置场景信息
    ↓
开始对话
    ↓
NPC 主动问候 ⭐
    ↓
玩家对话
    ↓
结束对话
    ↓
生成总结 + 下一幕故事

【第二幕】
查看故事 + NPC 对话
    ↓
开始对话
    ↓
显示 NPC 初始对话 ⭐
    ↓
玩家对话
    ↓
结束对话
    ↓
生成总结 + 下一幕故事

【第三幕】...
```

---

## 📝 配置说明

### 对话模块 System Prompt

**保持不变**，继续负责：
- 生成初始问候
- 回应玩家对话

### 故事模块 System Prompt

**已更新**，现在明确要求：
```
请生成：
1. 下一幕的场景描述和发生的事件
2. 一个主要NPC的初始对话（包括NPC名字、对话内容、情绪动画）

NPC初始对话格式要求：
- NPC名字：选择一个与场景最相关的NPC
- 对话内容：符合场景氛围和NPC性格
- 情绪动画：从以下选择（高兴、难过、失望、振奋、绝望、疯狂、希望、平静）
```

---

## 🎯 优势

### 1. 更自然的对话开场

**之前：**
```
（玩家进入场景）
玩家："有人吗？"  ← 玩家必须先说话
```

**现在：**
```
（玩家进入场景）
NPC："欢迎光临！"  ← NPC 主动问候
玩家：可以自然回应
```

### 2. 故事连贯性

**之前：**
```
故事：你们来到森林入口...
（玩家需要主动开始对话）
```

**现在：**
```
故事：你们来到森林入口...
NPC："准备好了吗？前面很危险。"  ← 自然过渡
```

### 3. 沉浸感提升

- ✅ NPC 更主动
- ✅ 场景切换更流畅
- ✅ 减少玩家困惑（"该说什么？"）

---

## 🎮 最佳实践

### 给 AI 的建议

**初始问候应该：**
- 与故事背景紧密相关
- 符合 NPC 的性格和目标
- 给玩家明确的对话方向

**好的示例：**
```
场景：你是私家侦探，来到豪宅调查案件
NPC：[管家詹姆斯] 您就是那位侦探吧？主人在书房等您。 [情绪：平静]
```

**避免的示例：**
```
NPC：[管家] 你好。 [情绪：平静]  ← 太简单，没有引导
```

### 故事模块的 NPC 选择

**应该选择：**
- 对下一幕最重要的 NPC
- 能推动情节发展的 NPC
- 与新场景最相关的 NPC

**示例：**
```
场景：战斗结束后，你们发现一个受伤的村民
应该选择：村民（新NPC，推动情节）
而不是：之前的队友（继续对话会更自然）
```

---

## 🔍 调试信息

**查看初始对话是否生效：**

1. 打开浏览器控制台（F12）
2. 进入对话页面
3. 查看日志：
   ```
   🤖 调用 OpenAI API
   📝 System Prompt: 你是一个资深的游戏DM...
   ```
4. 应该看到 NPC 的问候消息

---

## 🎉 总结

### 核心改进

1. **第一幕**：NPC 主动问候玩家（对话模块生成）
2. **第二幕及以后**：显示故事模块生成的 NPC 初始对话
3. **格式统一**：所有 NPC 对话包含名字 + 内容 + 情绪

### 影响的模块

- ✅ 对话模块：新增初始问候生成
- ✅ 故事模块：返回格式更新（加入情绪）
- ✅ 场景流转：自动显示初始对话

### 用户体验提升

- 🎭 更真实的角色扮演
- 🔗 更流畅的场景过渡
- 💬 更自然的对话开场

---

**现在开始享受更沉浸的 AI RPG 体验吧！** 🎮✨


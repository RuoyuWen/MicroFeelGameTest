# 系统更新说明

## 🎉 最新更新：NPC 初始对话功能（v2.1）

### ✨ 新功能：NPC 会主动开场！

**重大改进：**
- ✅ 第一幕开始时，NPC 主动问候玩家（基于故事背景）
- ✅ 第二幕及以后，自动显示故事模块生成的 NPC 初始对话
- ✅ 所有 NPC 对话格式统一（名字 + 内容 + 情绪）
- ✅ 更流畅的场景过渡和对话开场

**体验提升：**
```
之前：
（进入场景，等待玩家先说话）

现在：
[老板娘] 欢迎光临！第一次来这里吗？ [情绪：高兴]
（NPC 主动问候，引导对话）
```

📖 详细说明：查看 **NPC初始对话功能说明.md**

---

## 对话记忆功能（v2.0）

### ✨ 新功能：AI 现在有记忆了！

**重大改进：**
- ✅ NPC 会记住之前的对话内容（最近10轮）
- ✅ 可以引用之前说过的话
- ✅ 保持对话的连贯性和一致性
- ✅ 建立更真实的角色互动

**示例：**
```
玩家："我叫艾伦。"
NPC："你好，艾伦！"

（几轮对话后）

玩家："你还记得我的名字吗？"
NPC："当然记得，艾伦！"
```

📖 详细说明：查看 **对话记忆功能说明.md**

---

## 对话模块智能化改进（v1.0）

#### 改进内容

**之前：** 每次对话时，所有 NPC 都会回应玩家的输入  
**现在：** AI 根据语境智能判断让几个 NPC 回应（1个、2个或更多）

#### 为什么要改进？

在真实的对话场景中：
- ❌ 不是所有人都会对每句话做出反应
- ✅ 通常只有相关的人会回应
- ✅ 有时一个人说话，有时多个人讨论
- ✅ 这样更符合真实的对话逻辑

#### 改进效果

**场景示例 1：直接对话**
```
玩家："老板，给我来杯啤酒。"

之前可能的回应：
- 老板：好的，马上来！[情绪：高兴]
- 战士杰克：我也要一杯。[情绪：平静]
- 法师露娜：...（她可能不需要说话）

现在的回应：
- 老板：好的，马上来！[情绪：高兴]
（只有老板回应，更自然）
```

**场景示例 2：群体讨论**
```
玩家："有人愿意和我一起去探险吗？报酬丰厚！"

现在的回应（AI会判断多人回应更合适）：
- 战士杰克：听起来不错，算我一个！[情绪：振奋]
- 法师露娜：我需要了解更多细节。[情绪：平静]
（老板可能不参与，AI会根据情况决定）
```

**场景示例 3：特定对话**
```
玩家："杰克，你的剑术如何？"

现在的回应：
- 战士杰克：我曾在北方战场服役三年。[情绪：平静]
（只针对杰克的问题，其他NPC不会强行插话）
```

#### 技术改进

**1. System Prompt 优化**
```
新增的原则：
- 根据语境判断应该让几个NPC回应（可以是1个、2个或更多）
- 不是所有NPC都必须每次说话，要符合实际情况
- 如果玩家只对某个NPC说话，通常只需要那个NPC回应
- 如果是群体对话或引发争论，可以多个NPC回应
```

**2. 用户提示词优化**
```
添加了明确的指示：
"请根据上述信息和语境，决定让几个NPC回应
（1个、2个或更多都可以，要符合实际情况）。"
```

**3. JSON 模式说明**
```
JSON格式注释：
"注意：responses数组中只包含需要回应的NPC，
数量可以是1个或多个。"
```

#### 使用建议

为了获得最佳效果：

**1. 玩家输入要明确**
```
好的示例：
✅ "老板，给我来杯酒。"（明确对象）
✅ "大家好，我是新来的冒险者。"（群体问候）
✅ "杰克，你怎么看？"（指定对象）

一般示例：
⚠️ "有人在吗？"（AI会判断谁应该回应）
⚠️ "这里发生了什么？"（AI会判断谁知道）
```

**2. NPC 目标要清晰**
```
好的NPC目标设定：
✅ "老板想推销商品给所有顾客"
✅ "杰克只对战斗和冒险感兴趣"
✅ "露娜性格内向，不会主动说话"

这样AI可以更好地判断谁该说话
```

**3. 场景设置要合理**
```
在场景初始化时说明：
- 谁是主要角色（更容易说话）
- 谁是次要角色（可能不说话）
- NPC之间的关系如何
```

#### 预期行为

**单人回应场景：**
- 玩家点菜 → 只有老板回应
- 玩家问特定NPC问题 → 只有那个NPC回应
- 玩家私下对话 → 只有对话对象回应

**多人回应场景：**
- 玩家说重要消息 → 多个NPC反应
- 玩家提出争议话题 → 引发讨论
- 玩家询问群体 → 几个NPC回答

**可能零回应：**
- 如果玩家自言自语 → AI可能判断无人回应
- 如果话题与所有NPC无关 → 可能只有简短回应

#### 兼容性

此改进：
- ✅ 完全向后兼容
- ✅ 不需要修改现有场景
- ✅ 适用于 JSON 和文本模式
- ✅ 不影响其他模块功能

#### 对比总结

| 特性 | 之前 | 现在 |
|------|------|------|
| **NPC回应数量** | 固定（通常全部） | 灵活（1个或多个） |
| **语境感知** | 较弱 | 智能判断 |
| **对话自然度** | 一般 | 显著提升 |
| **AI自主性** | 低 | 高 |
| **场景真实感** | 中等 | 更真实 |

#### 实际测试建议

**测试1：单人对话**
```
玩家输入："老板，这里有什么任务？"
期望：只有老板回应
```

**测试2：群体提问**
```
玩家输入："有谁知道黑暗森林的情况？"
期望：知道信息的NPC回应（1-2个）
```

**测试3：引发讨论**
```
玩家输入："我觉得应该直接进攻！"
期望：多个NPC表达不同意见
```

**测试4：指定对话**
```
玩家输入："杰克，你准备好了吗？"
期望：只有杰克回应
```

#### 注意事项

⚠️ **AI的判断可能不总是完美**
- 有时AI可能让不该说话的NPC说话
- 有时应该说话的NPC可能沉默
- 这是AI的自然行为，可以通过调整System Prompt优化

✅ **如何优化**
- 如果NPC说话太少：在System Prompt中强调"积极参与"
- 如果NPC说话太多：强调"只在相关时回应"
- 在NPC目标中明确"性格特点"（话多/沉默）

#### 更新的文件

本次改进涉及以下文件更新：
1. ✅ index.html - 默认System Prompt
2. ✅ app.js - 用户提示词构建逻辑
3. ✅ README.md - 功能说明和示例
4. ✅ 故障排除指南.md - 优化建议

无需更新的文件：
- style.css（样式不变）
- 其他文档（原理相同）

---

## 如何体验新功能

### 方法1：刷新使用（推荐）
1. 刷新页面或重新打开 index.html
2. 新的默认System Prompt会自动加载
3. 按正常流程使用即可

### 方法2：手动更新（如果已填写）
1. 如果之前已经填写过配置
2. 删除对话模块的System Prompt
3. 刷新页面，系统会加载新的默认配置
4. 或参考README.md中的新示例手动修改

### 方法3：对比测试
1. 保存旧的System Prompt
2. 用新的System Prompt测试同一场景
3. 对比AI的回应差异
4. 选择你喜欢的版本

---

## 反馈与建议

使用过程中如果发现：
- ✨ NPC回应特别自然的场景
- ⚠️ AI判断不合理的情况
- 💡 进一步优化的想法

都可以记录下来，用于后续改进！

---

**享受更自然的AI对话体验！** 🎉

